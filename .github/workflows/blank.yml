# This is a basic workflow to help you get started with Actions

name: Download electron and release

# Controls when the workflow will run
on:
  # Allows you to run this workflow manually from the Actions tab
  workflow_dispatch:

env:
  # åœ¨æ­¤å¤„è®¾ç½®é»˜è®¤ç¯å¢ƒå˜é‡ï¼ˆå¯è¢«å·¥ä½œæµè°ƒåº¦æ—¶è¦†ç›–ï¼‰
  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
  GITHUB_OWNER: loong64-abi1-0
  GITHUB_REPO: electron

# A workflow run is made up of one or more jobs that can run sequentially or in parallel
jobs:
  # This workflow contains a single job called "build"
  build:
    # The type of runner that the job will run on
    runs-on: ubuntu-latest

    # Steps represent a sequence of tasks that will be executed as part of the job
    steps:
      # Checks-out your repository under $GITHUB_WORKSPACE, so your job can access it
      # - uses: actions/checkout@v4

      - name: Install Deps
        run: |
          sudo apt update
          sudo apt install gh jq wget curl -y

      # Runs a single command using the runners shell
      - name: Run a one-line script
        shell: bash
        run: |
          set -e
          # æ£€æŸ¥å¿…è¦å·¥å…·
          if ! command -v curl &> /dev/null; then
            echo "Error: curl is required but not installed. Exiting."
            exit 1
          fi
          if ! command -v jq &> /dev/null; then
            echo "Error: jq is required but not installed. Exiting."
            exit 1
          fi

          # ç¯å¢ƒå˜é‡é…ç½® (å»ºè®®é€šè¿‡ç¯å¢ƒå˜é‡è®¾ç½®)
          GITHUB_TOKEN="${GITHUB_TOKEN:-}"
          GITHUB_OWNER="${GITHUB_OWNER:-}"
          GITHUB_REPO="${GITHUB_REPO:-}"
          FTP_URL="https://ftp.loongnix.cn/electron/LoongArch"

          # éªŒè¯å¿…è¦å‚æ•°
          if [ -z "$GITHUB_TOKEN" ] || [ -z "$GITHUB_OWNER" ] || [ -z "$GITHUB_REPO" ]; then
            echo "Error: Missing required environment variables:"
            echo "  - GITHUB_TOKEN (GitHub personal access token)"
            echo "  - GITHUB_OWNER (GitHub repository owner)"
            echo "  - GITHUB_REPO (GitHub repository name)"
            exit 1
          fi

          echo "ğŸš€ Starting Electron release sync process..."

          # è·å–FTPç«™ç‚¹ç‰ˆæœ¬åˆ—è¡¨
          echo "ğŸ” Fetching versions from $FTP_URL..."
          PAGE_CONTENT=$(curl -s "$FTP_URL")
          if [ $? -ne 0 ]; then
            echo "âŒ Failed to fetch FTP page content. Check network connection or FTP URL."
            exit 1
          fi

          # æå–ç‰ˆæœ¬å· (åŒ¹é… vX.X.X/ æ ¼å¼)
          VERSIONS_FROM_FTP=$(echo "$PAGE_CONTENT" | grep -oP 'href="v\d+\.\d+\.\d+/"' | sed -E 's/href="v([0-9.]+)\/".*/v\1/')

          if [ -z "$VERSIONS_FROM_FTP" ]; then
            echo "âŒ No valid versions found in FTP response. Check FTP structure."
            exit 1
          fi

          echo "âœ… Found ${#VERSIONS_FROM_FTP[@]} versions from FTP"

          # è·å–GitHub Releaseåˆ—è¡¨
          echo "ğŸ”„ Fetching GitHub releases for $GITHUB_OWNER/$GITHUB_REPO..."
          RELEASES_DATA=$(curl -s -H "Authorization: token $GITHUB_TOKEN" \
            "https://api.github.com/repos/$GITHUB_OWNER/$GITHUB_REPO/releases")
          if [ $? -ne 0 ]; then
            echo "âŒ GitHub API request failed. Check token permissions or network."
            exit 1
          fi

          # æå–å·²å­˜åœ¨çš„tag names
          TAG_NAMES=$(echo "$RELEASES_DATA" | jq -r '.[].tag_name' 2>/dev/null)
          if [ $? -ne 0 ]; then
            echo "âŒ Failed to parse GitHub releases. Check jq installation or API response."
            exit 1
          fi

          echo "âœ… Found ${#TAG_NAMES[@]} existing releases in GitHub"

          # å¤„ç†æ¯ä¸ªæ–°ç‰ˆæœ¬
          for VERSION in $VERSIONS_FROM_FTP; do
            # æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨
            if echo "$TAG_NAMES" | grep -q "^$VERSION$"; then
              echo "â„¹ï¸  Version $VERSION already exists in GitHub. Skipping."
              continue
            fi

            echo "âœ¨ New version detected: $VERSION"

            # æ„å»ºä¸‹è½½URL
            DOWNLOAD_URL="$FTP_URL/$VERSION"

            # ä¸‹è½½æ–‡ä»¶
            echo "ğŸ“¥ Downloading $FILE_NAME from $DOWNLOAD_URL..."
            if ! wget -r -np -nH "$DOWNLOAD_URL"; then
              echo "âŒ Download failed for $DOWNLOAD_URL"
              exit 1
            fi

            # åˆ›å»ºGitHub Release
            echo "ğŸ“ Creating release for $VERSION..."
            gh release create "$VERSION" --title "$VERSION" --notes "Automated release for $VERSION" --repo "$GITHUB_OWNER/$GITHUB_REPO"
            gh release upload "$VERSION" ./electron/LoongArch/"$VERSION"/* --clobber --repo "$GITHUB_OWNER/$GITHUB_REPO"

            # æ¸…ç†ä¸´æ—¶æ–‡ä»¶
            rm -rf ./electron/LoongArch/"$VERSION"
          done

          echo "ğŸ‰ Process completed successfully!"
